// Generated by CoffeeScript 1.3.3
(function() {

  window.plugins.rollup = {
    emit: function(div, item) {},
    bind: function(div, item) {
      var $row, $table, asValue, attach, col, context, label, recalculate, reference, row, rows, slug, title, value, _i, _j, _len, _len1, _ref, _results;
      div.dblclick(function() {
        return wiki.textEditor(div, item);
      });
      asValue = function(obj) {
        if (obj == null) {
          return NaN;
        }
        switch (obj.constructor) {
          case Number:
            return obj;
          case String:
            return +obj;
          case Array:
            return asValue(obj[0]);
          case Object:
            return asValue(obj.value);
          case Function:
            return obj();
          default:
            return NaN;
        }
      };
      attach = function(search) {
        var elem, source, _i, _len, _ref;
        _ref = wiki.getDataNodes(div);
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          elem = _ref[_i];
          if ((source = $(elem).data('item')).text.indexOf(search) >= 0) {
            return source;
          }
          throw new Error("can't find dataset with caption " + search);
        }
      };
      reference = attach("Materials Summary");
      context = {
        foo: 0
      };
      recalculate = function($row, slug) {
        return wiki.getPlugin('method', function(plugin) {
          return $.getJSON("/" + slug + ".json", function(data) {
            return plugin["eval"](context, item, function() {
              return $row.find("td:first").append(" #" + context.foo);
            });
          });
        });
      };
      div.append("<style>\n  td.material {overflow:hidden;}\n  td.score {text-align:right; width:25px}\n</style>");
      div.append(($table = $("<table/>")));
      wiki.log('rollup', reference, reference.data, $table);
      rows = _.sortBy(reference.data, function(row) {
        return -asValue(row['Total Score']);
      });
      _results = [];
      for (_i = 0, _len = rows.length; _i < _len; _i++) {
        row = rows[_i];
        label = wiki.resolveLinks("[[" + row.Material + "]]");
        slug = wiki.asSlug(row.Material);
        $table.append(($row = $("<tr class=\"" + slug + "\">\n  <td class=\"material\">" + label + "</td>")));
        _ref = reference.columns;
        for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
          col = _ref[_j];
          if (col === 'Material') {
            continue;
          }
          value = asValue(row[col]);
          title = "" + row.Material + "\n" + col + "\n" + (value.toFixed(2));
          $row.append("<td class=\"score\" title=\"" + title + "\" data-thumb=\"" + col + "\">" + (value.toFixed(0)) + "</td>");
        }
        _results.push(recalculate($row, slug));
      }
      return _results;
    }
  };

}).call(this);
