// Generated by CoffeeScript 1.4.0
(function() {
  var WebSocketServer, fs, startServer, tz;

  WebSocketServer = require('ws').Server;

  fs = require('fs');

  fs = require('fs');

  tz = null;

  startServer = function(params) {
    var fn, k, server, v;
    console.log('txtzyme startServer', (function() {
      var _results;
      _results = [];
      for (k in params) {
        v = params[k];
        _results.push(k);
      }
      return _results;
    })());
    fn = '/dev/cu.usbmodem12341';
    fs.open(fn, 'r+', function(err, fd) {
      if (err) {
        console.log('txtzyme open error: ', err);
      }
      tz = {
        fd: fd,
        fn: fn
      };
      return console.log(tz);
    });
    server = new WebSocketServer({
      server: params.server,
      path: '/plugin/txtzyme'
    });
    return server.on('connection', function(socket) {
      console.log('connection established, listening');
      return socket.on('message', function(message) {
        var buf;
        buf = new Buffer("" + message + "\n", 'utf8');
        return fs.write(tz.fd, buf, 0, buf.length, -1, function(err, written, buffer) {
          if (err) {
            console.log('txtzyme write error: ', err);
          }
          return fs.fsync(tz.fd);
        });
      });
    });
  };

  module.exports = {
    startServer: startServer
  };

}).call(this);
